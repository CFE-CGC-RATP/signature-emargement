<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Émargement – Kiosque</title>
<style>
  body { font-family: system-ui; margin: 16px; }
  .box { max-width: 560px; margin: auto; }

  .card{
    margin: 12px 0 14px;
    padding: 12px 14px;
    border: 1px solid #ddd;
    border-radius: 12px;
    background: #f7f7f7;
  }
  .bigName{ font-size: 28px; font-weight: 800; line-height: 1.1; }
  .bigEvent{ margin-top: 6px; font-size: 18px; font-weight: 600; }
  .small { font-size: 13px; color: #666; }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size: 12px; }

  #readerWrap{
    margin: 12px 0 12px;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 12px;
  }
  #reader{ width: 100%; }

  canvas {
    border: 1px solid #444;
    border-radius: 12px;
    width: 100%;
    height: 240px;
    touch-action: none;
    background: #fff;
  }

  button {
    margin-top: 10px;
    padding: 10px 14px;
    font-size: 16px;
  }
  .btnRow { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .hidden { display: none; }

  .pill{
    display:inline-block;
    padding:2px 8px;
    border-radius: 999px;
    border:1px solid #ccc;
    font-size:12px;
    background:#fff;
    margin-left:6px;
  }

  ul { margin: 8px 0 0; padding-left: 18px; }
  li { margin: 4px 0; }

  input{
    width: 100%;
    padding: 10px;
    font-size: 16px;
    border-radius: 10px;
    border: 1px solid #ccc;
    box-sizing: border-box;
    margin-top: 6px;
  }

  .danger { color: #a40000; }
  .ok { color: #0a6b0a; }
</style>
</head>
<body>
<div class="box">
  <h2>Signature de présence (kiosque)</h2>

  <!-- Identité du mandataire -->
  <div class="card">
    <div id="name" class="bigName">Invité</div>
    <div id="eventLine" class="bigEvent"></div>
    <div class="small" id="tokenLine"></div>
  </div>

  <!-- Liste des personnes représentées (présent + pouvoirs) -->
  <div id="repWrap" class="card">
    <div class="btnRow" style="justify-content:space-between;">
      <div>
        <span style="font-weight:700;">Vous signez pour</span>
        <span class="pill" id="repCount">0</span>
        <span class="pill" id="powersCount">Pouvoirs: 0/3</span>
      </div>
      <button id="btnAddPouvoir">+ Ajouter un pouvoir papier</button>
    </div>
    <div class="small" style="margin-top:8px;">
      Inclut les pouvoirs pré-enregistrés + ceux ajoutés le jour J (papier). Maximum 3 pouvoirs par mandataire.
    </div>
    <ul id="repList"></ul>
    <div id="repMsg" class="small"></div>
  </div>

  <!-- SCAN QR -->
  <div id="readerWrap">
    <div class="small" style="margin-bottom:8px;">
      iPhone : cliquez sur “Démarrer le scan”, puis autorisez la caméra.
    </div>

    <div class="btnRow">
      <button id="btnStartScan">Démarrer le scan</button>
      <button id="btnStopScan" disabled>Arrêter le scan</button>
    </div>

    <div id="reader" style="margin-top:10px;"></div>
    <div id="scanStatus" class="small" style="margin-top:8px;">En attente…</div>
  </div>

  <!-- Zone signature -->
  <div id="signatureArea"></div>
  <canvas id="sign"></canvas>

  <div class="btnRow">
    <button onclick="clearPad()">Effacer</button>
    <button onclick="send()">Valider</button>
  </div>

  <div id="msg" class="small"></div>

  <!-- MODAL Ajout pouvoir papier -->
  <div id="modal" class="card hidden">
    <div style="font-weight:800; margin-bottom:6px;">Ajouter un pouvoir (papier)</div>
    <div class="small">Saisissez le nom/prénom du mandant (absent). Vous choisirez ensuite la bonne personne.</div>

    <div style="margin-top:10px;" class="small">Nom</div>
    <input id="inNom" placeholder="DUPONT">

    <div style="margin-top:10px;" class="small">Prénom</div>
    <input id="inPrenom" placeholder="Jean">

    <div style="margin-top:10px;" class="small">Note (optionnel)</div>
    <input id="inNote" placeholder="Pouvoir papier vérifié">

    <div class="btnRow">
      <button id="btnSearch">Rechercher</button>
      <button id="btnClose">Fermer</button>
    </div>

    <div id="searchMsg" class="small"></div>
    <ul id="searchResults"></ul>
  </div>
</div>

<!-- Lecteur QR -->
<script src="https://unpkg.com/html5-qrcode"></script>

<script>
/**
 * ===================== CONFIG =====================
 * 1) FLOW_GET_DELEGATIONS : renvoie la liste des personnes représentées (pré-enregistrés + jour J)
 *    Entrée : { event, mandataireToken }
 *    Sortie : { status:"ok", represented:[{token, prenom, nom, kind:"PERSONNEL"|"POUVOIR_PRE"|"POUVOIR_JOURJ", org?}] , maxPowers:3 }
 *
 * 2) FLOW_SEARCH_INVITE : recherche mandant par nom/prénom dans Invites
 *    Entrée : { event, nom, prenom }
 *    Sortie : { results:[{token, prenom, nom, org?}] }
 *
 * 3) FLOW_ADD_POUVOIR : ajoute un pouvoir papier le jour J (et doit appliquer le max 3 côté serveur aussi)
 *    Entrée : { event, mandataireToken, mandantToken, note }
 *    Sortie : { status:"ok"|"max_reached"|"already_signed"|"already_assigned"|"invalid_mandant" }
 *
 * 4) FLOW_SUBMIT_SIGNATURE : crée le PNG + crée les lignes Emargement (le serveur recalcule les représentés)
 *    Entrée : { event, mandataireToken, signature, ts }
 *    Sortie : { status:"ok"|"already_signed"|"error", count? }
 */
const FLOW_GET_DELEGATIONS = "URL_FLOW_GET_DELEGATIONS";
const FLOW_SEARCH_INVITE   = "URL_FLOW_SEARCH_INVITE";
const FLOW_ADD_POUVOIR     = "URL_FLOW_ADD_POUVOIR";
const FLOW_SUBMIT_SIGNATURE= "URL_FLOW_SUBMIT_SIGNATURE";

const MAX_POWERS = 3; // affichage côté client (le serveur doit aussi bloquer)

/** ========= Etat kiosque ========= */
let current = { prenom:"", nom:"", event:"", token:"" };
let represented = []; // [{token, prenom, nom, kind, org?}]

function $(id){ return document.getElementById(id); }

function setStatus(text){ $("scanStatus").textContent = text; }
function setMsg(text, cls){
  $("msg").className = "small " + (cls || "");
  $("msg").textContent = text || "";
}
function setRepMsg(text, cls){
  $("repMsg").className = "small " + (cls || "");
  $("repMsg").textContent = text || "";
}

function updateInfo(){
  const fullName = ((current.prenom||"") + " " + (current.nom||"")).trim();
  $("name").textContent = fullName || "Invité";
  $("eventLine").textContent = current.event || "";
  $("tokenLine").textContent = current.token ? ("Token: " + current.token) : "";
}

function countPowers(){
  // Exclut la signature personnelle
  return represented.filter(r => r.kind !== "PERSONNEL").length;
}

function renderRepresented(){
  const ul = $("repList");
  ul.innerHTML = "";

  represented.forEach(r => {
    const li = document.createElement("li");
    let tag = "";
    if (r.kind === "PERSONNEL") tag = "présent";
    else if (r.kind === "POUVOIR_PRE") tag = "pouvoir (pré-enregistré)";
    else if (r.kind === "POUVOIR_JOURJ") tag = "pouvoir (papier)";
    else tag = "pouvoir";

    li.textContent = `${(r.prenom||"").trim()} ${(r.nom||"").trim()} — ${tag}${r.org ? " — " + r.org : ""}`;
    ul.appendChild(li);
  });

  const total = represented.length;
  const pow = countPowers();
  $("repCount").textContent = total;
  $("powersCount").textContent = `Pouvoirs: ${pow}/${MAX_POWERS}`;

  // Bloque le bouton d'ajout si max atteint ou pas de mandataire
  $("btnAddPouvoir").disabled = (!current.token || !current.event || pow >= MAX_POWERS);
  if (pow >= MAX_POWERS) setRepMsg("Maximum de 3 pouvoirs atteint pour ce mandataire.", "danger");
  else setRepMsg("", "");
}

/** ========= Signature pad ========= */
const canvas = $("sign");
const ctx = canvas.getContext("2d");

function resizeCanvas() {
  const r = devicePixelRatio || 1;
  ctx.setTransform(1,0,0,1,0,0);
  canvas.width = canvas.offsetWidth * r;
  canvas.height = canvas.offsetHeight * r;
  ctx.scale(r, r);
  ctx.lineWidth = 2;
  ctx.lineCap = "round";
}
resizeCanvas();
window.addEventListener("resize", resizeCanvas);

let drawing = false;
let last = null;

function pos(e){
  const t = e.touches ? e.touches[0] : e;
  const r = canvas.getBoundingClientRect();
  return { x: t.clientX - r.left, y: t.clientY - r.top };
}
canvas.addEventListener("touchstart", e => { drawing=true; last=pos(e); e.preventDefault(); }, {passive:false});
canvas.addEventListener("touchmove", e => {
  if(!drawing) return;
  const p = pos(e);
  ctx.beginPath();
  ctx.moveTo(last.x, last.y);
  ctx.lineTo(p.x, p.y);
  ctx.stroke();
  last = p;
  e.preventDefault();
}, {passive:false});
canvas.addEventListener("touchend", () => drawing=false);

function clearPad(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
}

/** ========= QR scanner (iPhone-friendly) ========= */
let qr = null;
let scanning = false;
let scanLocked = false;

async function startScan(){
  if (scanning) return;
  scanLocked = false;

  try {
    if (!qr) qr = new Html5Qrcode("reader");
    setMsg("");
    setStatus("Démarrage caméra…");

    await qr.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: { width: 260, height: 260 } },
      (decodedText) => {
        if (scanLocked) return;
        scanLocked = true;
        handleQr(decodedText);
      },
      (_err) => {}
    );

    scanning = true;
    $("btnStartScan").disabled = true;
    $("btnStopScan").disabled = false;
    setStatus("Caméra prête. Présentez le QR.");
  } catch (e) {
    scanning = false;
    $("btnStartScan").disabled = false;
    $("btnStopScan").disabled = true;
    setStatus("Caméra bloquée. Vérifie : Safari + autorisation caméra (Réglages iOS > Safari > Caméra).");
  }
}

async function stopScan(){
  if (!qr || !scanning) return;
  try { qr.pause(true); } catch(e) {}
  try { await qr.stop(); } catch(e) {}
  scanning = false;
  $("btnStartScan").disabled = false;
  $("btnStopScan").disabled = true;
  setStatus("Scan arrêté.");
}

/** ========= Parse QR =========
 * QR idéal : URL complète avec ?prenom=&nom=&event=&t=
 * ex: https://.../?prenom=Jean&nom=Dupont&event=AG2026&t=ABC123
 */
function parseQr(decodedText){
  try {
    const u = new URL(decodedText);
    const q = u.searchParams;
    return {
      prenom: q.get("prenom") || "",
      nom: q.get("nom") || "",
      event: q.get("event") || "",
      token: q.get("t") || ""
    };
  } catch (e) {
    // fallback : on ne sait pas, on met tout en token
    return { prenom:"", nom:"", event:"", token: decodedText || "" };
  }
}

/** ========= Charger les pouvoirs (pré-enregistrés + jour J) ========= */
async function loadDelegations(){
  if (!FLOW_GET_DELEGATIONS || FLOW_GET_DELEGATIONS.startsWith("URL_")) {
    // si tu n'as pas encore le flow, on affiche seulement le mandataire
    represented = [];
    if (current.token) represented.push({ token: current.token, prenom: current.prenom, nom: current.nom, kind:"PERSONNEL" });
    renderRepresented();
    return;
  }

  setRepMsg("Chargement des pouvoirs…", "");
  try {
    const r = await fetch(FLOW_GET_DELEGATIONS, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ event: current.event, mandataireToken: current.token })
    });
    const j = await r.json();

    if (j.status !== "ok") {
      represented = [{ token: current.token, prenom: current.prenom, nom: current.nom, kind:"PERSONNEL" }];
      renderRepresented();
      setRepMsg("Impossible de charger les pouvoirs (mode dégradé).", "danger");
      return;
    }

    represented = Array.isArray(j.represented) && j.represented.length ? j.represented : [];
    // sécurité: si le flow ne renvoie pas le personnel, on l'ajoute
    if (!represented.some(x => x.token === current.token)) {
      represented.unshift({ token: current.token, prenom: current.prenom, nom: current.nom, kind:"PERSONNEL" });
    }

    renderRepresented();
    setRepMsg("", "");
  } catch (e) {
    represented = [{ token: current.token, prenom: current.prenom, nom: current.nom, kind:"PERSONNEL" }];
    renderRepresented();
    setRepMsg("Erreur réseau lors du chargement des pouvoirs.", "danger");
  }
}

/** ========= Quand un QR est lu ========= */
async function handleQr(decodedText){
  current = parseQr(decodedText);
  updateInfo();
  clearPad();
  setMsg("");
  setStatus("QR détecté ✓");

  // Stopper le scan
  await stopScan();

  // Charger pouvoirs pré-enregistrés + jour J
  await loadDelegations();

  // Aller à la zone signature
  $("signatureArea").scrollIntoView({ behavior:"smooth" });

  // Cacher le scanner après un petit délai (iPhone)
  setTimeout(() => $("readerWrap").classList.add("hidden"), 300);
}

/** ========= Modal ajout pouvoir papier ========= */
$("btnAddPouvoir").addEventListener("click", () => {
  if (!current.token || !current.event) { setRepMsg("Scannez d’abord le QR du mandataire.", "danger"); return; }
  if (countPowers() >= MAX_POWERS) { setRepMsg("Maximum de 3 pouvoirs atteint.", "danger"); return; }

  $("modal").classList.remove("hidden");
  $("searchMsg").textContent = "";
  $("searchResults").innerHTML = "";
});

$("btnClose").addEventListener("click", () => {
  $("modal").classList.add("hidden");
});

$("btnSearch").addEventListener("click", async () => {
  const nom = ($("inNom").value || "").trim();
  const prenom = ($("inPrenom").value || "").trim();
  const note = ($("inNote").value || "").trim();

  if (!nom || !prenom) { $("searchMsg").textContent = "Renseignez Nom + Prénom."; return; }
  if (!FLOW_SEARCH_INVITE || FLOW_SEARCH_INVITE.startsWith("URL_")) {
    $("searchMsg").textContent = "FLOW_SEARCH_INVITE non configuré.";
    return;
  }

  $("searchMsg").textContent = "Recherche…";
  $("searchResults").innerHTML = "";

  try {
    const r = await fetch(FLOW_SEARCH_INVITE, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ event: current.event, nom, prenom })
    });
    const j = await r.json();
    const results = j.results || [];

    if (!results.length) { $("searchMsg").textContent = "Aucun résultat."; return; }

    $("searchMsg").textContent = "Sélectionnez la bonne personne :";
    const ul = $("searchResults");

    results.forEach(cand => {
      const li = document.createElement("li");
      const btn = document.createElement("button");
      btn.textContent = `Ajouter : ${cand.prenom} ${cand.nom}${cand.org ? " — " + cand.org : ""}`;

      btn.onclick = async () => {
        if (countPowers() >= MAX_POWERS) {
          $("searchMsg").textContent = "Maximum 3 pouvoirs atteint.";
          return;
        }
        if (!FLOW_ADD_POUVOIR || FLOW_ADD_POUVOIR.startsWith("URL_")) {
          $("searchMsg").textContent = "FLOW_ADD_POUVOIR non configuré.";
          return;
        }

        $("searchMsg").textContent = "Enregistrement du pouvoir…";

        const r2 = await fetch(FLOW_ADD_POUVOIR, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({
            event: current.event,
            mandataireToken: current.token,
            mandantToken: cand.token,
            note
          })
        });
        const j2 = await r2.json();

        if (j2.status === "ok") {
          $("searchMsg").textContent = "Pouvoir ajouté ✅";
          // Recharger la liste depuis le serveur (source de vérité)
          await loadDelegations();
        } else if (j2.status === "max_reached") {
          $("searchMsg").textContent = "Maximum 3 pouvoirs déjà atteints.";
        } else if (j2.status === "already_signed") {
          $("searchMsg").textContent = "Cette personne est déjà émargée.";
        } else if (j2.status === "already_assigned") {
          $("searchMsg").textContent = "Pouvoir déjà enregistré.";
        } else if (j2.status === "invalid_mandant") {
          $("searchMsg").textContent = "Mandant introuvable / invalide pour cet événement.";
        } else {
          $("searchMsg").textContent = "Erreur (vérifiez le flow).";
        }
      };

      li.appendChild(btn);
      ul.appendChild(li);
    });

  } catch (e) {
    $("searchMsg").textContent = "Erreur réseau.";
  }
});

/** ========= Envoi signature =========
 * IMPORTANT : on envoie seulement (event, mandataireToken, signature).
 * Le serveur recalcule la liste des représentés (pré + jour J) et applique le max=3.
 */
async function send(){
  if (!FLOW_SUBMIT_SIGNATURE || FLOW_SUBMIT_SIGNATURE.startsWith("URL_")) {
    setMsg("⚠️ Configure FLOW_SUBMIT_SIGNATURE dans le code.", "danger");
    return;
  }
  if (!current.token || !current.event) {
    setMsg("Scannez d’abord le QR du mandataire.", "danger");
    return;
  }

  const img = canvas.toDataURL("image/png");

  setMsg("Envoi…", "");
  try {
    const r = await fetch(FLOW_SUBMIT_SIGNATURE, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        event: current.event,
        mandataireToken: current.token,
        signature: img,
        ts: new Date().toISOString()
      })
    });
    const j = await r.json();

    if (j.status === "already_signed") {
      setMsg("⚠️ Déjà émargé (mandataire ou mandants).", "danger");
      return;
    }
    if (j.status !== "ok") {
      setMsg("❌ Erreur lors de l’enregistrement. Vérifiez le flow.", "danger");
      return;
    }

    setMsg(`✅ Signature enregistrée. (${j.count || represented.length} émargement(s))`, "ok");

    // Reset + prochain scan
    setTimeout(async () => {
      // reset état
      current = { prenom:"", nom:"", event:"", token:"" };
      represented = [];
      updateInfo();
      renderRepresented();
      clearPad();
      setRepMsg("", "");

      // UI
      $("modal").classList.add("hidden");
      $("readerWrap").classList.remove("hidden");
      $("readerWrap").scrollIntoView({ behavior:"smooth" });

      // relance scan
      await startScan();
    }, 1200);

  } catch (e) {
    setMsg("❌ Erreur réseau (connexion ?).", "danger");
    // autorise un rescan si besoin
    scanLocked = false;
  }
}

/** ========= Boutons scan ========= */
$("btnStartScan").addEventListener("click", startScan);
$("btnStopScan").addEventListener("click", stopScan);

/** ========= (Optionnel) test via URL params =========
 * si tu ouvres la page avec ?prenom=&nom=&event=&t= on pré-remplit (utile pour debug)
 */
(function loadFromPageUrlIfPresent(){
  const qs = new URLSearchParams(location.search);
  const p = qs.get("prenom");
  const n = qs.get("nom");
  const ev = qs.get("event");
  const t = qs.get("t");
  if (p || n || ev || t) {
    current = { prenom: p || "", nom: n || "", event: ev || "", token: t || "" };
    updateInfo();
    loadDelegations();
  } else {
    updateInfo();
    renderRepresented();
  }
})();
</script>
</body>
</html>
