<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Émargement</title>
<style>
body { font-family: system-ui; margin: 16px; }
.box { max-width: 520px; margin: auto; }
canvas {
  border: 1px solid #444;
  border-radius: 12px;
  width: 100%;
  height: 220px;
  touch-action: none;
}
button {
  margin-top: 12px;
  padding: 10px 16px;
  font-size: 16px;
}
.small { font-size: 13px; color: #666; }
.infoBox{
  margin: 12px 0 14px;
  padding: 12px 14px;
  border: 1px solid #ddd;
  border-radius: 12px;
  background: #f7f7f7;
}
.bigName{
  font-size: 28px;
  font-weight: 800;
  line-height: 1.1;
}
.bigEvent{
  margin-top: 6px;
  font-size: 18px;
  font-weight: 600;
}

</style>
</head>
<body>
<div class="box">
  <h2>Signature de présence</h2>
  <div class="infoBox">
  <div id="name" class="bigName"></div>
  <div id="eventLine" class="bigEvent"></div>
</div>


  <canvas id="sign"></canvas>

  <button onclick="clearPad()">Effacer</button>
  <button onclick="send()">Valider</button>

  <div id="msg" class="small"></div>
</div>

<script>
const qs = new URLSearchParams(location.search);
const prenom = qs.get("prenom");
const nom = qs.get("nom");
const event = qs.get("event");
const token = qs.get("t");

document.getElementById("info").textContent =
  prenom + " " + nom + " — " + event;

const canvas = document.getElementById("sign");
const ctx = canvas.getContext("2d");

function resize() {
  const r = devicePixelRatio || 1;
  canvas.width = canvas.offsetWidth * r;
  canvas.height = canvas.offsetHeight * r;
  ctx.scale(r, r);
  ctx.lineWidth = 2;
  ctx.lineCap = "round";
}
resize();

let draw = false;
let last = null;

function pos(e){
  const t = e.touches ? e.touches[0] : e;
  const r = canvas.getBoundingClientRect();
  return { x: t.clientX - r.left, y: t.clientY - r.top };
}

canvas.addEventListener("touchstart", e => { draw=true; last=pos(e); e.preventDefault(); });
canvas.addEventListener("touchmove", e => {
  if(!draw) return;
  const p = pos(e);
  ctx.beginPath();
  ctx.moveTo(last.x, last.y);
  ctx.lineTo(p.x, p.y);
  ctx.stroke();
  last = p;
  e.preventDefault();
});
canvas.addEventListener("touchend", () => draw=false);

function clearPad(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
}

async function send(){
  const img = canvas.toDataURL("image/png");

  await fetch("TON_URL_POWER_AUTOMATE", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      token, prenom, nom, event,
      signature: img
    })
  });

  document.getElementById("msg").textContent = "Signature enregistrée. Merci.";
}
</script>
</body>
</html>
